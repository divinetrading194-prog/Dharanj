<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dharani Snap</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700;900&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .text-gradient {
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        .hero-gradient {
            background-image: linear-gradient(to right bottom, #34d399, #10b981);
        }
        .main-gradient {
            background-image: linear-gradient(to bottom right, #ffffff, #f3f4f6);
        }
        .button-gradient {
            background-image: linear-gradient(to right, #4ade80, #16a34a);
        }
    </style>
</head>
<body class="bg-gray-100 flex flex-col items-center p-4 sm:p-8 min-h-screen">
    <!-- Header with a clean, professional look -->
    <header class="w-full max-w-3xl flex justify-between items-center py-4 px-6 bg-white rounded-full shadow-lg mb-8 drop-shadow-md">
        <h1 id="app-title" class="text-2xl sm:text-3xl font-extrabold text-green-600 cursor-pointer transition-colors duration-200">Dharani Snap</h1>
        <div class="flex items-center space-x-2">
            <!-- Home button is the only navigation in the header now -->
            <button id="home-btn" class="p-2 sm:p-3 rounded-full bg-green-50 hover:bg-green-100 text-green-700 transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-green-400">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M3 12l2-2m0 0l7-7 7 7m-14 4v7a1 1 0 001 1h6a1 1 0 001-1v-7a1 1 0 011-1h2a1 1 0 011 1v7a1 1 0 001 1h6a1 1 0 001-1v-7m-14 4h18" />
                </svg>
            </button>
        </div>
    </header>

    <!-- Main content container with a subtle gradient and shadow -->
    <main id="main-content" class="w-full max-w-3xl flex-1 main-gradient rounded-3xl shadow-xl p-4 sm:p-8 transition-all duration-300 flex flex-col items-center justify-center text-center">
        <!-- Dynamic content will be rendered here -->
    </main>

    <!-- Professional, animated modal -->
    <div id="modal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4 bg-gray-900 bg-opacity-50 transition-opacity duration-300">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md p-6 transform transition-transform duration-300 scale-95">
            <div class="flex justify-between items-center pb-3 border-b-2 border-gray-200 mb-4">
                <h3 id="modal-title" class="text-2xl font-bold text-gray-800"></h3>
                <button id="modal-close-btn" class="text-gray-400 hover:text-gray-600 focus:outline-none transition-transform duration-200 transform hover:scale-110">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>
            <div id="modal-content" class="text-gray-700 leading-relaxed mb-6"></div>
            <div id="modal-actions" class="flex justify-end space-x-3 mt-4"></div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            const mainContent = document.getElementById('main-content');
            const modal = document.getElementById('modal');
            const modalTitle = document.getElementById('modal-title');
            const modalContent = document.getElementById('modal-content');
            const modalActions = document.getElementById('modal-actions');
            const modalCloseBtn = document.getElementById('modal-close-btn');
            const appTitle = document.getElementById('app-title');
            const homeBtn = document.getElementById('home-btn');

            // This is the API Key provided by the user.
            const API_KEY = "AIzaSyDCEF0uk3x7YMLZuaNHOklU01iTYjYVS6Q"; 
            const MODEL_NAME = 'gemini-2.5-flash-preview-05-20';
            
            // Local variables for state, replacing Firebase
            let currentQuizQuestions = [];
            let currentQuestionIndex = 0;
            let roundScore = 0;
            // The quiz data is stored locally and will be reset on page refresh.
            let quizData = { score: 0, streak: 0, unlocked_achievements: {} };

            const achievements = {
                "first_correct": { name: "First Step", description: "Get your first correct answer." },
                "streak_3": { name: "Eco Apprentice", description: "Get 3 correct answers in a row." },
                "streak_5": { name: "Eco Champion", description: "Get 5 correct answers in a row." },
                "total_10": { name: "Eco Guru", description: "Get a total of 10 correct answers." }
            };

            const showModal = (title, content, actions = []) => {
                modalTitle.textContent = title;
                modalContent.innerHTML = '';
                if (typeof content === 'string') {
                    modalContent.innerHTML = content;
                } else {
                    modalContent.appendChild(content);
                }
                modalActions.innerHTML = '';
                actions.forEach(action => {
                    const button = document.createElement('button');
                    button.textContent = action.label;
                    button.onclick = action.action;
                    button.className = "px-6 py-2 rounded-full font-semibold text-white button-gradient hover:opacity-90 focus:outline-none focus:ring-2 focus:ring-green-500 transition-colors duration-200 shadow-md";
                    modalActions.appendChild(button);
                });
                modal.classList.remove('hidden');
                setTimeout(() => {
                    modal.querySelector('div').classList.add('scale-100');
                    modal.querySelector('div').classList.remove('scale-95');
                }, 10);
            };

            const hideModal = () => {
                modal.querySelector('div').classList.remove('scale-100');
                modal.querySelector('div').classList.add('scale-95');
                setTimeout(() => {
                    modal.classList.add('hidden');
                }, 300);
            };

            modalCloseBtn.addEventListener('click', hideModal);
            appTitle.addEventListener('click', renderHomeScreen);
            homeBtn.addEventListener('click', renderHomeScreen);

            function renderHomeScreen() {
                mainContent.innerHTML = `
                    <div class="p-6 text-center">
                        <div class="hero-gradient p-8 rounded-3xl shadow-xl mb-8 transform transition-transform duration-300 hover:scale-105">
                            <h2 class="text-4xl sm:text-5xl font-black text-white mb-2">Welcome to Dharani Snap!</h2>
                            <p class="text-lg sm:text-xl text-white font-medium">Your personal guide to an eco-friendly life.</p>
                        </div>
                        <div class="space-y-4">
                            <button id="reusability-btn" class="w-full py-4 px-6 bg-white border border-green-200 text-green-700 font-bold text-lg rounded-2xl shadow-lg transition-all duration-300 transform hover:scale-105 hover:bg-green-50 focus:outline-none focus:ring-2 focus:ring-green-400">
                                <span class="flex items-center justify-center"><span class="text-2xl mr-3">‚ôªÔ∏è</span> Check Reusability</span>
                            </button>
                            <button id="quiz-btn" class="w-full py-4 px-6 bg-white border border-blue-200 text-blue-700 font-bold text-lg rounded-2xl shadow-lg transition-all duration-300 transform hover:scale-105 hover:bg-blue-50 focus:outline-none focus:ring-2 focus:ring-blue-400">
                                <span class="flex items-center justify-center"><span class="text-2xl mr-3">üß†</span> Eco Quiz</span>
                            </button>
                            <button id="chatbot-btn" class="w-full py-4 px-6 bg-white border border-purple-200 text-purple-700 font-bold text-lg rounded-2xl shadow-lg transition-all duration-300 transform hover:scale-105 hover:bg-purple-50 focus:outline-none focus:ring-2 focus:ring-purple-400">
                                <span class="flex items-center justify-center"><span class="text-2xl mr-3">üí¨</span> Eco Chatbot</span>
                            </button>
                        </div>
                    </div>
                `;
                document.getElementById('reusability-btn').addEventListener('click', renderReusabilityCheckScreen);
                document.getElementById('quiz-btn').addEventListener('click', renderQuizScreen);
                document.getElementById('chatbot-btn').addEventListener('click', renderChatbotScreen);
            }

            function renderReusabilityCheckScreen() {
                mainContent.innerHTML = `
                    <div class="p-6 w-full text-center">
                        <h2 class="text-3xl font-extrabold text-green-800 mb-4">Reusability Check</h2>
                        <p class="text-lg text-gray-700 mb-6">Upload an image and let's find out how to give your item a second life!</p>
                        <div id="reusability-output" class="hidden bg-green-50 p-6 rounded-2xl shadow-inner mt-4 text-left"></div>
                        <button id="start-check-btn" class="mt-8 w-full py-3 px-6 text-white font-bold rounded-full shadow-lg transition-all duration-300 transform hover:scale-105 button-gradient focus:outline-none focus:ring-2 focus:ring-green-400">
                            Start New Check
                        </button>
                    </div>
                `;
                document.getElementById('start-check-btn').addEventListener('click', startReusabilityCheck);
            }

            const startReusabilityCheck = () => {
                const fileInput = document.createElement('input');
                fileInput.type = 'file';
                fileInput.accept = 'image/*';
                fileInput.setAttribute('capture', 'camera');
                fileInput.onchange = (e) => {
                    const file = e.target.files[0];
                    if (file) {
                        handleImageUpload(file);
                    }
                };
                fileInput.click();
            };

            const handleImageUpload = (file) => {
                if (!API_KEY) {
                    showModal("API Key Missing", "Please provide a valid API key to use this feature.", [{ label: "OK", action: hideModal }]);
                    return;
                }
                const reader = new FileReader();
                reader.onload = async (event) => {
                    const base64ImageData = event.target.result.split(',')[1];
                    const prompt = `
                        You are an expert in waste management and sustainability with a specific focus on Indian contexts.
                        Analyze the item in the image and provide a detailed, structured response in JSON format.
                        The response must include:
                        
                        1.  \`dharanis_choice\`: A single string that is either "Reuse" or "Dispose", indicating the most eco-friendly action.
                        2.  \`reusability_analysis\`: A nested object for reuse information.
                            a. \`item\`: A clear name for the object.
                            b. \`reusability_tip\`: A detailed, practical, and creative tip on how to reuse the item.
                            c. \`swachh_bharat_impact\`: A brief explanation of how this specific action supports the Swachh Bharat Abhiyan and its impact on India's waste management goals.
                            d. \`environmental_impact\`: A concise summary of the broader environmental benefits of this action (e.g., saving resources, reducing pollution).
                        3.  \`disposal_guidance\`: A nested object for disposal information.
                            a. \`waste_type\`: Classify the waste as "Biodegradable", "Non-Biodegradable", "E-Waste", or "Hazardous".
                            b. \`disposal_method\`: An explanation of the proper way to dispose of the item.
                            c. \`which_bin\`: The specific type of bin (e.g., "Green bin for wet waste," "Blue bin for dry waste") or location to dispose of it.
                        
                        The response should be formatted as a single JSON object with these three top-level keys.
                    `;

                    mainContent.innerHTML = `
                        <div class="p-6 w-full text-center">
                            <h2 class="text-3xl font-extrabold text-green-800 mb-4">Analyzing...</h2>
                            <p class="text-lg text-gray-700 mb-6">Please wait while the AI analyzes your item.</p>
                            <img src="${event.target.result}" alt="Item to be analyzed" class="mx-auto rounded-xl shadow-lg max-h-64 object-contain mb-8">
                            <div id="loading-spinner" class="w-20 h-20 border-4 border-green-200 border-t-green-600 rounded-full animate-spin mx-auto"></div>
                        </div>
                    `;

                    try {
                        const payload = {
                            contents: [{
                                parts: [
                                    { text: prompt },
                                    { inlineData: { mimeType: file.type, data: base64ImageData } }
                                ]
                            }],
                            generationConfig: {
                                responseMimeType: "application/json",
                                responseSchema: {
                                    "type": "OBJECT",
                                    "properties": {
                                        "dharanis_choice": { "type": "STRING" },
                                        "reusability_analysis": {
                                            "type": "OBJECT",
                                            "properties": {
                                                "item": { "type": "STRING" },
                                                "reusability_tip": { "type": "STRING" },
                                                "swachh_bharat_impact": { "type": "STRING" },
                                                "environmental_impact": { "type": "STRING" }
                                            },
                                            "propertyOrdering": ["item", "reusability_tip", "swachh_bharat_impact", "environmental_impact"]
                                        },
                                        "disposal_guidance": {
                                            "type": "OBJECT",
                                            "properties": {
                                                "waste_type": { "type": "STRING" },
                                                "disposal_method": { "type": "STRING" },
                                                "which_bin": { "type": "STRING" }
                                            },
                                            "propertyOrdering": ["waste_type", "disposal_method", "which_bin"]
                                        }
                                    },
                                    "propertyOrdering": ["dharanis_choice", "reusability_analysis", "disposal_guidance"]
                                }
                            }
                        };
                        
                        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${API_KEY}`;
                        let response;
                        let retries = 0;
                        while(retries < 3) {
                            try {
                                response = await fetch(apiUrl, {
                                    method: 'POST',
                                    headers: { 'Content-Type': 'application/json' },
                                    body: JSON.stringify(payload)
                                });
                                if (response.ok) break;
                            } catch (e) {}
                            retries++;
                            await new Promise(res => setTimeout(res, Math.pow(2, retries) * 1000));
                        }

                        const result = await response.json();
                        const jsonString = result?.candidates?.[0]?.content?.parts?.[0]?.text;
                        const output = JSON.parse(jsonString);
                        displayReusabilityOutput(output);
                    } catch (error) {
                        console.error("Gemini API error:", error);
                        const output = {
                            dharanis_choice: "Undecided",
                            reusability_analysis: {
                                item: "Unknown Item",
                                reusability_tip: "I couldn't identify this item. Please try again with a clearer image.",
                                swachh_bharat_impact: "By continuing to try, you are contributing to a cleaner future for India.",
                                environmental_impact: "Your efforts in reducing waste, even through a simple photo, help lessen the load on our environment."
                            },
                            disposal_guidance: {
                                waste_type: "Unknown",
                                disposal_method: "No specific method can be provided.",
                                which_bin: "Please try again."
                            }
                        };
                        displayReusabilityOutput(output);
                    }
                };
                reader.readAsDataURL(file);
            };

            const displayReusabilityOutput = (output) => {
                const ra = output.reusability_analysis;
                const dg = output.disposal_guidance;
                mainContent.innerHTML = `
                    <div class="p-6 w-full text-center">
                        <h2 class="text-3xl font-extrabold text-green-800 mb-4">Reusability Check</h2>
                        
                        <div class="p-6 rounded-2xl shadow-lg mt-4 text-left space-y-6">
                            
                            <!-- Dharani's Choice Section -->
                            <div class="p-6 rounded-2xl shadow-xl border-4 ${output.dharanis_choice === 'Reuse' ? 'border-green-400 bg-green-50' : 'border-red-400 bg-red-50'}">
                                <h3 class="text-2xl font-bold mb-2 flex items-center justify-center text-gray-800">
                                    <span class="mr-2">${output.dharanis_choice === 'Reuse' ? '‚ôªÔ∏è' : 'üóëÔ∏è'}</span>
                                    Dharani's Choice: <span class="font-black ml-2 ${output.dharanis_choice === 'Reuse' ? 'text-green-600' : 'text-red-600'}">${output.dharanis_choice}</span>
                                </h3>
                            </div>

                            <!-- Reusability Analysis Section -->
                            <div class="p-4 bg-white rounded-xl shadow-lg border border-green-200">
                                <h3 class="font-bold text-xl text-green-700 mb-2 flex items-center"><span class="text-2xl mr-2">üí°</span> Reusability Analysis</h3>
                                <p class="text-lg font-semibold flex items-center text-gray-600 mb-2"><span class="text-xl mr-2">üì¶</span>Item: <span class="text-green-600 ml-2">${ra.item}</span></p>
                                <div class="bg-gray-50 p-3 rounded-lg border border-gray-200">
                                    <h4 class="font-bold text-base text-gray-800 mb-1">Tip:</h4>
                                    <p class="text-gray-700">${ra.reusability_tip}</p>
                                </div>
                                <div class="bg-gray-50 p-3 rounded-lg border border-gray-200 mt-2">
                                    <h4 class="font-bold text-base text-gray-800 mb-1">Swachh Bharat Impact:</h4>
                                    <p class="text-gray-700">${ra.swachh_bharat_impact}</p>
                                </div>
                                <div class="bg-gray-50 p-3 rounded-lg border border-gray-200 mt-2">
                                    <h4 class="font-bold text-base text-gray-800 mb-1">Environmental Impact:</h4>
                                    <p class="text-gray-700">${ra.environmental_impact}</p>
                                </div>
                            </div>
                            
                            <!-- Disposal Guidance Section -->
                            <div class="p-4 bg-white rounded-xl shadow-lg border border-red-200">
                                <h3 class="font-bold text-xl text-red-700 mb-2 flex items-center"><span class="text-2xl mr-2">üóëÔ∏è</span> Disposal Guidance</h3>
                                <div class="bg-gray-50 p-3 rounded-lg border border-gray-200">
                                    <h4 class="font-bold text-base text-gray-800 mb-1">Waste Type:</h4>
                                    <p class="text-gray-700">${dg.waste_type}</p>
                                </div>
                                <div class="bg-gray-50 p-3 rounded-lg border border-gray-200 mt-2">
                                    <h4 class="font-bold text-base text-gray-800 mb-1">Disposal Method:</h4>
                                    <p class="text-gray-700">${dg.disposal_method}</p>
                                </div>
                                <div class="bg-gray-50 p-3 rounded-lg border border-gray-200 mt-2">
                                    <h4 class="font-bold text-base text-gray-800 mb-1">Which Bin:</h4>
                                    <p class="text-gray-700">${dg.which_bin}</p>
                                </div>
                            </div>
                            
                        </div>
                        <button id="start-check-btn" class="mt-8 w-full py-3 px-6 text-white font-bold rounded-full shadow-lg transition-all duration-300 transform hover:scale-105 button-gradient focus:outline-none focus:ring-2 focus:ring-green-400">
                            Start New Check
                        </button>
                    </div>
                `;
                document.getElementById('start-check-btn').addEventListener('click', renderReusabilityCheckScreen);
            };

            /**
             * Function to fetch quiz questions from the Gemini API.
             * Includes retry logic for robustness.
             */
            async function getQuizQuestionsFromAPI() {
                if (!API_KEY) {
                     // If API key is missing, show modal and return empty array
                     showModal("API Key Missing", "Please provide a valid API key to use this feature.", [{ label: "OK", action: hideModal }]);
                     return [];
                }
                
                // üö® UPDATED PROMPT for better question variety.
                const prompt = `
                    Generate a JSON array of 5 unique and informative multiple-choice questions. Ensure the questions cover a diverse range of eco-friendly topics, such as renewable energy, waste management, water conservation, biodiversity, and sustainable consumption. Each question must have four options (A, B, C, D), a single correct answer, a short phrase for a correct response, and a short phrase for an incorrect response. The questions should be suitable for a general audience.
                `;
                
                const payload = {
                    contents: [{ role: 'user', parts: [{ text: prompt }] }],
                    generationConfig: {
                        responseMimeType: "application/json",
                        responseSchema: {
                            "type": "ARRAY",
                            "items": {
                                "type": "OBJECT",
                                "properties": {
                                    "question": { "type": "STRING" },
                                    "options": {
                                        "type": "OBJECT",
                                        "properties": {
                                            "A": { "type": "STRING" },
                                            "B": { "type": "STRING" },
                                            "C": { "type": "STRING" },
                                            "D": { "type": "STRING" }
                                        },
                                        "propertyOrdering": ["A", "B", "C", "D"]
                                    },
                                    "answer": { "type": "STRING" },
                                    "correctPhrase": { "type": "STRING" },
                                    "incorrectPhrase": { "type": "STRING" }
                                },
                                "propertyOrdering": ["question", "options", "answer", "correctPhrase", "incorrectPhrase"]
                            }
                        }
                    }
                };

                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${MODEL_NAME}:generateContent?key=${API_KEY}`;
                let response;
                let retries = 0;
                // Exponential backoff for API calls
                while(retries < 3) {
                    try {
                        response = await fetch(apiUrl, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload)
                        });
                        if (response.ok) break;
                    } catch (e) {
                         // Catch network errors
                    }
                    retries++;
                    await new Promise(res => setTimeout(res, Math.pow(2, retries) * 1000));
                }
                
                if (!response.ok) {
                    // Throw an error if all retries fail
                    throw new Error("Failed to fetch quiz questions from API.");
                }

                const result = await response.json();
                const jsonString = result?.candidates?.[0]?.content?.parts?.[0]?.text;
                // Parse the JSON response
                return JSON.parse(jsonString);
            }

            /**
             * Renders the main quiz screen, showing scores and achievements from local state.
             */
            function renderQuizScreen() {
                mainContent.innerHTML = `
                    <div class="p-6 w-full text-center">
                        <div class="bg-green-100 p-6 rounded-2xl shadow-md mb-8">
                            <h2 class="text-3xl font-extrabold text-green-800 mb-4">Eco Quiz</h2>
                            <p class="text-lg text-gray-700 mb-6">Test your knowledge and become an Eco Warrior!</p>
                            <p class="text-3xl font-bold text-green-600 mb-2">Total Score: <span id="quiz-score">${quizData.score}</span></p>
                            <p class="text-xl font-medium text-gray-700">Current Streak: <span id="quiz-streak">${quizData.streak}</span></p>
                        </div>
                        <div id="achievements-container" class="bg-gray-100 p-4 rounded-xl shadow-inner mb-6 text-left ${Object.keys(quizData.unlocked_achievements).length > 0 ? '' : 'hidden'}">
                            <h3 class="font-bold text-lg mb-2 flex items-center text-gray-800"><span class="text-2xl mr-2">üèÜ</span> My Achievements</h3>
                            <ul id="achievements-list" class="space-y-2"></ul>
                        </div>
                        <div id="quiz-container" class="space-y-4"></div>
                        <button id="start-quiz-btn" class="mt-8 w-full py-3 px-6 text-white font-bold rounded-full shadow-lg transition-all duration-300 transform hover:scale-105 button-gradient focus:outline-none focus:ring-2 focus:ring-green-400">
                            Start Quiz
                        </button>
                    </div>
                `;
                
                const achievementsList = document.getElementById('achievements-list');
                const achievementsContainer = document.getElementById('achievements-container');
                if (Object.keys(quizData.unlocked_achievements).length > 0) {
                    for (const key in quizData.unlocked_achievements) {
                        if (quizData.unlocked_achievements[key]) {
                            const achievementItem = document.createElement('li');
                            achievementItem.className = 'flex items-center space-x-2 text-green-800';
                            achievementItem.innerHTML = `<span class="text-2xl">üèÖ</span><span>${achievements[key].name}: ${achievements[key].description}</span>`;
                            achievementsList.appendChild(achievementItem);
                        }
                    }
                    achievementsContainer.classList.remove('hidden');
                } else {
                    achievementsContainer.classList.add('hidden');
                }
                
                document.getElementById('start-quiz-btn').addEventListener('click', startQuiz);
            }

            /**
             * Initializes a new quiz round by fetching questions from the API.
             * Displays a loading spinner while waiting for the response.
             */
            const startQuiz = async () => {
                const quizContainer = document.getElementById('quiz-container');
                const startQuizBtn = document.getElementById('start-quiz-btn');
                startQuizBtn.classList.add('hidden');
                
                quizContainer.innerHTML = `
                    <div class="p-6 w-full text-center">
                        <div id="loading-spinner" class="w-20 h-20 border-4 border-blue-200 border-t-blue-600 rounded-full animate-spin mx-auto"></div>
                        <p class="mt-4 text-gray-700">Generating new quiz questions...</p>
                    </div>
                `;

                try {
                    currentQuizQuestions = await getQuizQuestionsFromAPI();
                    currentQuestionIndex = 0;
                    roundScore = 0;
                    if (currentQuizQuestions && currentQuizQuestions.length > 0) {
                        loadQuestion();
                    } else {
                         // Fallback to quiz screen if API key is missing or questions not found
                         renderQuizScreen();
                    }
                } catch (error) {
                    console.error("Error generating quiz questions:", error);
                    quizContainer.innerHTML = `
                        <div class="p-6 w-full text-center text-red-600">
                            <p class="text-xl font-bold">Failed to load quiz questions.</p>
                            <p class="mt-2 text-lg">Please check your internet connection and ensure your API key is correct.</p>
                        </div>
                    `;
                    startQuizBtn.classList.remove('hidden');
                }
            };

            /**
             * Loads and displays the current question in the quiz.
             * Handles the end-of-round state.
             */
            const loadQuestion = () => {
                const quizContainer = document.getElementById('quiz-container');
                
                if (currentQuestionIndex >= currentQuizQuestions.length) {
                    // This block should ideally not be reached with the new logic, but remains as a safeguard
                    return;
                }
                
                const question = currentQuizQuestions[currentQuestionIndex];
                
                quizContainer.innerHTML = `
                    <div class="bg-white p-6 rounded-2xl shadow-xl space-y-4 text-left">
                        <p class="text-xl font-bold text-gray-900">Question ${currentQuestionIndex + 1} of 5:</p>
                        <p class="text-lg text-gray-800 mb-4">${question.question}</p>
                        <div id="options-container" class="space-y-3">
                            ${Object.entries(question.options).map(([key, value]) => `
                                <button data-answer="${key}" class="w-full text-left p-4 rounded-xl border border-gray-200 bg-gray-50 hover:bg-green-100 transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-green-500 quiz-option-btn">
                                    <span class="font-semibold text-green-600 mr-2">${key}:</span>
                                    <span class="text-gray-800">${value}</span>
                                </button>
                            `).join('')}
                        </div>
                    </div>
                `;

                // Attach event listeners after content is rendered
                quizContainer.querySelectorAll('.quiz-option-btn').forEach(btn => {
                    btn.addEventListener('click', async (e) => {
                        const userAnswer = e.currentTarget.dataset.answer;
                        const correct = question.answer;
                        
                        // Disable all buttons to prevent multiple clicks
                        quizContainer.querySelectorAll('.quiz-option-btn').forEach(b => b.disabled = true);
                        
                        let title, message, newAchievement = null;
                        
                        if (userAnswer.toUpperCase() === correct.toUpperCase()) {
                            quizData.score = (quizData.score || 0) + 1;
                            quizData.streak = (quizData.streak || 0) + 1;
                            roundScore++;
                            e.currentTarget.classList.add('bg-green-200', 'ring-2', 'ring-green-500');
                            title = "‚úÖ Correct!";
                            message = `<p class="text-lg text-green-600 font-semibold">${question.correctPhrase}</p>`;
                            
                            // Check and unlock achievements
                            if (quizData.score === 1 && !quizData.unlocked_achievements["first_correct"]) {
                                quizData.unlocked_achievements["first_correct"] = true;
                                newAchievement = achievements["first_correct"].name;
                            }
                            if (quizData.streak === 3 && !quizData.unlocked_achievements["streak_3"]) {
                                quizData.unlocked_achievements["streak_3"] = true;
                                newAchievement = achievements["streak_3"].name;
                            }
                            if (quizData.streak === 5 && !quizData.unlocked_achievements["streak_5"]) {
                                quizData.unlocked_achievements["streak_5"] = true;
                                newAchievement = achievements["streak_5"].name;
                            }
                            if (quizData.score === 10 && !quizData.unlocked_achievements["total_10"]) {
                                quizData.unlocked_achievements["total_10"] = true;
                                newAchievement = achievements["total_10"].name;
                            }
                            
                        } else {
                            // Incorrect answer
                            quizData.streak = 0;
                            e.currentTarget.classList.add('bg-red-200', 'ring-2', 'ring-red-500');
                            title = "‚ùå Incorrect!";
                            message = `<p class="text-lg text-red-600 font-semibold">${question.incorrectPhrase}</p>`;
                            // Highlight the correct answer
                            const correctButton = quizContainer.querySelector(`[data-answer="${correct}"]`);
                            if (correctButton) {
                                correctButton.classList.add('bg-green-200', 'ring-2', 'ring-green-500');
                            }
                        }

                        // Update UI with new score and streak from local state
                        document.getElementById('quiz-score').textContent = quizData.score;
                        document.getElementById('quiz-streak').textContent = quizData.streak;

                        // Check if this is the last question
                        if (currentQuestionIndex + 1 >= currentQuizQuestions.length) {
                             // Last question, show "Round Complete" modal directly
                            let roundPhrase = "";
                            if (roundScore === 5) {
                                roundPhrase = "Perfect score! You're an Eco Master! üíØ";
                            } else if (roundScore >= 3) {
                                roundPhrase = "Great job! Keep up the good work! üå±";
                            } else {
                                roundPhrase = "Every answer is a step forward! You'll ace the next round! üí™";
                            }
                            
                            showModal("Round Complete!", `<p class="text-xl font-bold mb-4">Your score is: ${roundScore} out of 5</p><p>${roundPhrase}</p>`, 
                                [
                                    {
                                        label: 'Start New Round',
                                        action: () => {
                                            hideModal();
                                            startQuiz();
                                        }
                                    },
                                    {
                                        label: 'Back to Home',
                                        action: () => {
                                            hideModal();
                                            renderHomeScreen();
                                        }
                                    }
                                ]
                            );

                        } else {
                            // Not the last question, show feedback modal and then move to next
                            if (newAchievement) {
                                showModal(title, `${message}<p class="mt-4">You've unlocked the achievement: <strong>${newAchievement}</strong>! üéâ</p>`, [{label: 'Next', action: () => { hideModal(); currentQuestionIndex++; loadQuestion(); }}]);
                            } else {
                                showModal(title, message, [{label: 'Next', action: () => { hideModal(); currentQuestionIndex++; loadQuestion(); }}]);
                            }
                        }
                    });
                });
            };

            function renderChatbotScreen() {
                mainContent.innerHTML = `
                    <div class="p-6 flex flex-col h-full w-full">
                        <h2 class="text-3xl font-extrabold text-green-800 mb-4 text-center">Eco Chatbot</h2>
                        <p class="text-lg text-gray-700 mb-6 text-center">Ask me anything about eco-friendly living!</p>
                        <div id="chat-history" class="flex-1 overflow-y-auto p-4 bg-white rounded-2xl shadow-inner mb-4 space-y-4 max-h-[60vh] min-h-[40vh]"></div>
                        <form id="chat-form" class="flex space-x-2">
                            <input id="chat-input" type="text" placeholder="Ask me a question..." class="flex-1 px-4 py-3 border border-gray-300 rounded-full focus:outline-none focus:ring-2 focus:ring-green-500 transition-colors"/>
                            <button type="submit" id="chat-submit-btn" class="p-3 bg-green-600 hover:bg-green-700 text-white rounded-full transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-green-500">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8" />
                                </svg>
                            </button>
                        </form>
                    </div>
                `;
                const chatForm = document.getElementById('chat-form');
                chatForm.addEventListener('submit', handleChatSubmit);
            }

            const handleChatSubmit = async (e) => {
                e.preventDefault();
                if (!API_KEY) {
                    showModal("API Key Missing", "Please provide a valid API key to use this feature.", [{ label: "OK", action: hideModal }]);
                    return;
                }
                const chatInput = document.getElementById('chat-input');
                const chatHistory = document.getElementById('chat-history');
                const chatSubmitBtn = document.getElementById('chat-submit-btn');
                let input = chatInput.value.trim();
                if (!input) return;

                const userMessage = document.createElement('div');
                userMessage.className = "flex justify-end";
                userMessage.innerHTML = `<div class="max-w-[75%] p-4 rounded-2xl bg-green-600 text-white rounded-br-none shadow-md">${input}</div>`;
                chatHistory.appendChild(userMessage);

                chatInput.value = '';
                chatSubmitBtn.disabled = true;

                const loadingMessage = document.createElement('div');
                loadingMessage.className = "flex justify-start";
                loadingMessage.innerHTML = `<div class="max-w-[75%] p-4 rounded-2xl bg-gray-200 text-gray-800 rounded-bl-none animate-pulse shadow-md">Thinking...</div>`;
                chatHistory.appendChild(loadingMessage);
                chatHistory.scrollTop = chatHistory.scrollHeight;

                let botResponseText = '';

                try {
                    const payload = {
                        contents: [{ role: 'user', parts: [{ text: `You are a helpful eco-friendly assistant. Answer the following question about recycling, reusing, or eco-friendly practices. Be concise and informative, like a chatbot. The user is asking: "${input}"` }] }],
                    };
                    const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${API_KEY}`;
                    
                    let response;
                    let retries = 0;
                    while(retries < 3) {
                        try {
                            response = await fetch(apiUrl, {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify(payload),
                            });
                            if (response.ok) break;
                        } catch (e) {}
                        retries++;
                        await new Promise(res => setTimeout(res, Math.pow(2, retries) * 1000));
                    }
                    const result = await response.json();
                    const text = result?.candidates?.[0]?.content?.parts?.[0]?.text || "I'm sorry, I couldn't process that request right now.";
                    botResponseText = text;
                } catch (error) {
                    console.error("Gemini API error:", error);
                    botResponseText = "Sorry, I'm having trouble connecting right now. Please try again later.";
                }

                loadingMessage.remove();

                const botMessage = document.createElement('div');
                botMessage.className = "flex justify-start";
                botMessage.innerHTML = `<div class="max-w-[75%] p-4 rounded-2xl bg-gray-200 text-gray-800 rounded-bl-none shadow-md">${botResponseText}</div>`;
                chatHistory.appendChild(botMessage);
                chatHistory.scrollTop = chatHistory.scrollHeight;

                chatSubmitBtn.disabled = false;
            };

            // Start the application
            renderHomeScreen();
        });
    </script>
</body>
</html>